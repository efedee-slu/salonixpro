// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// BUSINESS & AUTHENTICATION
// ============================================

model Business {
  id            String   @id @default(cuid())
  name          String
  slug          String   @unique
  email         String?
  phone         String?
  address       String?
  city          String?
  country       String   @default("Saint Lucia")
  currency      String   @default("XCD")
  currencySymbol String  @default("EC$")
  timezone      String   @default("America/St_Lucia")
  logo          String?
  businessHours Json?
  
  // Location
  latitude      Float?
  longitude     Float?
  locationLandmark String?  // "Near KFC, beside the pharmacy"
  
  // Deposit & Payment Settings
  requiresDeposit     Boolean @default(false)
  depositType         String  @default("percentage") // "fixed" or "percentage"
  depositAmount       Decimal? @db.Decimal(10, 2)    // if fixed
  depositPercentage   Int     @default(25)           // if percentage
  paymentDeadlineHours Int    @default(48)           // 24 or 48
  bankName            String?
  bankAccountName     String?
  bankAccountNumber   String?
  paymentInstructions String?
  
  // Subscription & Trial
  subscriptionStatus SubscriptionStatus @default(TRIAL)
  trialEndsAt   DateTime?
  subscriptionPlan String?
  paypalSubscriptionId String?
  subscriptionStartDate DateTime?
  subscriptionEndDate DateTime?
  
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  users         User[]
  services      Service[]
  serviceCategories ServiceCategory[]
  stylists      Stylist[]
  clients       Client[]
  appointments  Appointment[]
  products      Product[]
  productCategories ProductCategory[]
  orders        Order[]
  notifications Notification[]
  
  @@index([slug])
}

enum SubscriptionStatus {
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

model User {
  id            String   @id @default(cuid())
  businessId    String
  email         String
  username      String
  passwordHash  String
  firstName     String?
  lastName      String?
  phone         String?
  role          Role     @default(STYLIST)
  avatar        String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  stylist       Stylist?
  
  @@unique([businessId, email])
  @@unique([businessId, username])
  @@index([businessId])
}

enum Role {
  OWNER
  MANAGER
  STYLIST
  ASSISTANT
}

// ============================================
// SERVICES
// ============================================

model ServiceCategory {
  id            String   @id @default(cuid())
  businessId    String
  name          String
  icon          String?
  description   String?
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  services      Service[]
  
  @@unique([businessId, name])
  @@index([businessId])
}

model Service {
  id            String   @id @default(cuid())
  businessId    String
  categoryId    String?
  name          String
  description   String?
  duration      Int      // minutes
  price         Decimal  @db.Decimal(10, 2)
  isActive      Boolean  @default(true)
  isCustom      Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category      ServiceCategory? @relation(fields: [categoryId], references: [id])
  stylistServices StylistService[]
  appointmentServices AppointmentService[]
  
  @@index([businessId])
  @@index([categoryId])
}

// ============================================
// STYLISTS
// ============================================

model Stylist {
  id            String   @id @default(cuid())
  businessId    String
  userId        String?  @unique
  firstName     String
  lastName      String
  email         String?
  phone         String?
  bio           String?
  avatar        String?
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  user          User?     @relation(fields: [userId], references: [id])
  services      StylistService[]
  schedules     StylistSchedule[]
  timeOff       StylistTimeOff[]
  appointments  Appointment[]
  
  @@index([businessId])
}

model StylistService {
  id            String   @id @default(cuid())
  stylistId     String
  serviceId     String
  customPrice   Decimal? @db.Decimal(10, 2)
  customDuration Int?
  createdAt     DateTime @default(now())

  // Relations
  stylist       Stylist  @relation(fields: [stylistId], references: [id], onDelete: Cascade)
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@unique([stylistId, serviceId])
}

model StylistSchedule {
  id            String   @id @default(cuid())
  stylistId     String
  dayOfWeek     Int      // 0 = Sunday, 6 = Saturday
  startTime     String   // "09:00"
  endTime       String   // "18:00"
  isWorking     Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  stylist       Stylist  @relation(fields: [stylistId], references: [id], onDelete: Cascade)
  
  @@unique([stylistId, dayOfWeek])
}

model StylistTimeOff {
  id            String   @id @default(cuid())
  stylistId     String
  startDate     DateTime
  endDate       DateTime
  reason        String?
  createdAt     DateTime @default(now())

  // Relations
  stylist       Stylist  @relation(fields: [stylistId], references: [id], onDelete: Cascade)
  
  @@index([stylistId])
}

// ============================================
// CLIENTS
// ============================================

model Client {
  id            String   @id @default(cuid())
  businessId    String
  firstName     String
  lastName      String
  email         String?
  phone         String
  address       String?
  notes         String?
  totalVisits   Int      @default(0)
  totalSpent    Decimal  @default(0) @db.Decimal(10, 2)
  lastVisitAt   DateTime?
  isVip         Boolean  @default(false)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business      @relation(fields: [businessId], references: [id], onDelete: Cascade)
  appointments  Appointment[]
  orders        Order[]
  
  @@unique([businessId, phone])
  @@index([businessId])
}

// ============================================
// APPOINTMENTS
// ============================================

model Appointment {
  id            String   @id @default(cuid())
  businessId    String
  clientId      String
  stylistId     String?
  status        AppointmentStatus @default(PENDING)
  requestedDate DateTime
  confirmedDate DateTime?
  duration      Int      // total minutes
  totalPrice    Decimal  @db.Decimal(10, 2)
  notes         String?
  cancelReason  String?
  
  // Deposit Tracking
  bookingReference    String?   @unique  // BK-XXXXXX
  depositAmount       Decimal?  @db.Decimal(10, 2)
  depositStatus       DepositStatus @default(NOT_REQUIRED)
  paymentDeadline     DateTime?
  paymentSubmittedAt  DateTime?
  paymentConfirmedAt  DateTime?
  autoCancelledAt     DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        Client    @relation(fields: [clientId], references: [id])
  stylist       Stylist?  @relation(fields: [stylistId], references: [id])
  services      AppointmentService[]
  order         Order?
  
  @@index([businessId])
  @@index([clientId])
  @@index([stylistId])
  @@index([status])
  @@index([requestedDate])
  @@index([bookingReference])
  @@index([depositStatus])
}

model AppointmentService {
  id            String   @id @default(cuid())
  appointmentId String
  serviceId     String
  serviceName   String   // snapshot
  price         Decimal  @db.Decimal(10, 2)
  duration      Int

  // Relations
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  service       Service     @relation(fields: [serviceId], references: [id])
}

enum AppointmentStatus {
  PENDING
  PENDING_DEPOSIT
  CONFIRMED
  ARRIVED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  AUTO_CANCELLED
  NO_SHOW
}

enum DepositStatus {
  NOT_REQUIRED
  PENDING
  SUBMITTED
  CONFIRMED
  WAIVED
  EXPIRED
}

// ============================================
// PRODUCTS & INVENTORY
// ============================================

model ProductCategory {
  id            String   @id @default(cuid())
  businessId    String
  name          String
  icon          String?
  description   String?
  sortOrder     Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business  @relation(fields: [businessId], references: [id], onDelete: Cascade)
  products      Product[]
  
  @@unique([businessId, name])
  @@index([businessId])
}

model Product {
  id            String   @id @default(cuid())
  businessId    String
  categoryId    String?
  sku           String
  name          String
  description   String?
  
  // Hair-specific attributes
  texture       String?
  lengthInches  Int?
  color         String?
  
  // Pricing
  costPrice     Decimal  @default(0) @db.Decimal(10, 2)
  retailPrice   Decimal  @db.Decimal(10, 2)
  salePrice     Decimal? @db.Decimal(10, 2)
  isOnSale      Boolean  @default(false)
  promoText     String?
  
  // Inventory
  stockOnHand   Int      @default(0)
  stockReserved Int      @default(0)
  reorderLevel  Int      @default(5)
  
  // Display
  images        String[] @default([])
  isFeatured    Boolean  @default(false)
  isAvailableOnline Boolean @default(true)
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  category      ProductCategory? @relation(fields: [categoryId], references: [id])
  orderItems    OrderItem[]
  
  @@unique([businessId, sku])
  @@index([businessId])
  @@index([categoryId])
}

// ============================================
// ORDERS
// ============================================

model Order {
  id            String   @id @default(cuid())
  businessId    String
  orderNumber   String   @unique
  clientId      String?
  appointmentId String?  @unique
  
  // Status
  status        OrderStatus    @default(PENDING)
  paymentStatus PaymentStatus  @default(UNPAID)
  paymentMethod PaymentMethod?
  
  // Pricing
  subtotal      Decimal  @db.Decimal(10, 2)
  discount      Decimal  @default(0) @db.Decimal(10, 2)
  total         Decimal  @db.Decimal(10, 2)
  
  // Customer info (for guest checkout)
  customerName  String?
  customerPhone String?
  customerEmail String?
  customerNotes String?
  
  // Fulfillment
  pickupDate    DateTime?
  staffNotes    String?
  
  // Timestamps
  confirmedAt   DateTime?
  readyAt       DateTime?
  completedAt   DateTime?
  cancelledAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  business      Business     @relation(fields: [businessId], references: [id], onDelete: Cascade)
  client        Client?      @relation(fields: [clientId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  items         OrderItem[]
  
  @@index([businessId])
  @@index([clientId])
  @@index([status])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  productId     String
  
  // Snapshot at time of order
  productSku    String
  productName   String
  quantity      Int
  unitPrice     Decimal  @db.Decimal(10, 2)
  salePrice     Decimal? @db.Decimal(10, 2)
  lineTotal     Decimal  @db.Decimal(10, 2)
  
  createdAt     DateTime @default(now())

  // Relations
  order         Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product       Product @relation(fields: [productId], references: [id])
}

enum OrderStatus {
  CART
  PENDING
  CONFIRMED
  READY
  COMPLETED
  CANCELLED
}

enum PaymentStatus {
  UNPAID
  PAID
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id            String   @id @default(cuid())
  businessId    String
  type          NotificationType
  title         String
  message       String
  data          Json?    // Extra data (appointmentId, etc.)
  isRead        Boolean  @default(false)
  isUrgent      Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  // Relations
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  @@index([businessId])
  @@index([isRead])
  @@index([createdAt])
}

enum NotificationType {
  BOOKING_NEW
  PAYMENT_SUBMITTED
  PAYMENT_DEADLINE_WARNING
  PAYMENT_EXPIRED
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  GENERAL
}
